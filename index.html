<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学园偶像大师 支援卡分析</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #ffffff;
            color: #333333;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
        }

        header {
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            font-size: 24px;
            font-weight: 400;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .section {
            margin: 32px 0;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 24px;
        }

        .section h2 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .canvas-container {
            display: flex;
            justify-content: center;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 24px;
            min-height: 500px;
        }

        canvas {
            display: block;
            max-width: 100%;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
            min-height: 200px;
        }

        .card-item {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .card-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .card-image {
            width: 100%;
            aspect-ratio: 1.82 / 1;
            object-fit: cover;
            background: #f5f5f5;
            margin-bottom: 8px;
        }

        .card-name {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
            word-break: break-word;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
            grid-column: 1 / -1;
        }

        .info-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            padding: 12px;
            background: #fafafa;
            border-left: 3px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 12px;
            }

            .section {
                padding: 16px;
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 12px;
            }

            header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>学园偶像大师 支援卡共同出现分析</h1>
        </div>
    </header>

    <div class="container">
        <div class="section">
            <h2>角色关系网络</h2>
            <div class="canvas-container">
                <canvas id="networkCanvas"></canvas>
            </div>
            <div class="info-text">
                点击圆形中的任意两个角色头像，查看他们共同出现的支援卡
            </div>
        </div>

        <div class="section">
            <h2 id="cardTitle">支援卡列表</h2>
            <div id="cardsContainer" class="cards-grid">
                <div class="empty-state">
                    选择两个角色以查看共同出现的支援卡
                </div>
            </div>
        </div>
    </div>

    <script src="visualizer_data_complete.js"></script>
    <script>
        class NetworkVisualizer {
            constructor(canvasId, characters, coAppearances) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) {
                    console.error('Canvas not found');
                    return;
                }
                
                this.ctx = this.canvas.getContext('2d');
                this.characters = characters;
                this.coAppearances = coAppearances;
                this.selectedCharacters = [];
                this.positions = {};
                this.characterImages = {};
                
                this.setupCanvas();
                this.calculatePositions();
                this.loadCharacterImages();
                this.setupEvents();
                this.draw();
            }

            setupCanvas() {
                const wrapper = this.canvas.parentElement;
                this.canvas.width = Math.min(wrapper.offsetWidth - 32, 800);
                this.canvas.height = 600;
                window.addEventListener('resize', () => this.handleResize());
            }

            handleResize() {
                const wrapper = this.canvas.parentElement;
                this.canvas.width = Math.min(wrapper.offsetWidth - 32, 800);
                this.calculatePositions();
                this.draw();
            }

            calculatePositions() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = Math.min(centerX, centerY) - 80;

                this.characters.forEach((char, index) => {
                    const angle = (index / this.characters.length) * Math.PI * 2 - Math.PI / 2;
                    this.positions[char.id] = {
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius
                    };
                });
            }

            loadCharacterImages() {
                this.characters.forEach(char => {
                    const img = new Image();
                    img.src = char.image;
                    img.onload = () => {
                        this.characterImages[char.id] = img;
                        this.draw();
                    };
                });
            }

            getRelationshipKey(id1, id2) {
                return [id1, id2].sort().join('_');
            }

            getLineStyle(count) {
                // 根据出现次数计算线条样式
                // count: 1-20 映射到 t: 0-1
                const maxCount = 20;
                const v = Math.min(count, maxCount);
                const t = (v - 1) / 19;
                
                return {
                    alpha: 0.2 + 0.8 * t,
                    width: 0.5 + 2.0 * t
                };
            }

            drawLines() {
                const drawn = new Set();

                this.characters.forEach(char1 => {
                    this.characters.forEach(char2 => {
                        if (char1.id >= char2.id) return;

                        const key = this.getRelationshipKey(char1.id, char2.id);
                        const relationship = this.coAppearances[key];

                        if (relationship) {
                            const pos1 = this.positions[char1.id];
                            const pos2 = this.positions[char2.id];
                            const style = this.getLineStyle(relationship.count);

                            this.ctx.strokeStyle = `rgba(255, 0, 0, ${style.alpha})`;
                            this.ctx.lineWidth = style.width;
                            this.ctx.lineCap = 'round';

                            this.ctx.beginPath();
                            this.ctx.moveTo(pos1.x, pos1.y);
                            this.ctx.lineTo(pos2.x, pos2.y);
                            this.ctx.stroke();
                        }

                        drawn.add(`${char1.id}_${char2.id}`);
                    });
                });
            }

            drawCharacters() {
                const characterRadius = 32;

                this.characters.forEach(char => {
                    const pos = this.positions[char.id];
                    const isSelected = this.selectedCharacters.includes(char.id);

                    // 白色背景圆
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.strokeStyle = '#e0e0e0';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, characterRadius + 2, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.stroke();

                    // 绘制头像
                    if (this.characterImages[char.id]) {
                        this.ctx.save();
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, characterRadius, 0, Math.PI * 2);
                        this.ctx.clip();
                        const img = this.characterImages[char.id];
                        this.ctx.drawImage(img, pos.x - characterRadius, pos.y - characterRadius, characterRadius * 2, characterRadius * 2);
                        this.ctx.restore();
                    } else {
                        this.ctx.fillStyle = '#f5f5f5';
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, characterRadius, 0, Math.PI * 2);
                        this.ctx.fill();
                    }

                    // 选中效果
                    if (isSelected) {
                        this.ctx.strokeStyle = '#333333';
                        this.ctx.lineWidth = 2;
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, characterRadius + 5, 0, Math.PI * 2);
                        this.ctx.stroke();
                    }
                });
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawLines();
                this.drawCharacters();
            }

            setupEvents() {
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
            }

            handleCanvasClick(event) {
                const rect = this.canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                for (let char of this.characters) {
                    const pos = this.positions[char.id];
                    const distance = Math.sqrt((x - pos.x) ** 2 + (y - pos.y) ** 2);

                    if (distance < 40) {
                        this.toggleCharacterSelection(char.id);
                        return;
                    }
                }
            }

            toggleCharacterSelection(charId) {
                const index = this.selectedCharacters.indexOf(charId);
                if (index > -1) {
                    this.selectedCharacters.splice(index, 1);
                } else {
                    if (this.selectedCharacters.length >= 2) {
                        this.selectedCharacters.shift();
                    }
                    this.selectedCharacters.push(charId);
                }

                this.draw();
                this.updateInfoPanel();
            }

            updateInfoPanel() {
                const container = document.getElementById('cardsContainer');
                const cardTitle = document.getElementById('cardTitle');

                if (this.selectedCharacters.length !== 2) {
                    container.innerHTML = `
                        <div class="empty-state">
                            选择两个角色以查看共同出现的支援卡
                        </div>
                    `;
                    cardTitle.textContent = '支援卡列表';
                    return;
                }

                const [id1, id2] = this.selectedCharacters;
                const char1 = this.characters.find(c => c.id === id1);
                const char2 = this.characters.find(c => c.id === id2);

                cardTitle.textContent = `支援卡列表 - ${char1.name} × ${char2.name}`;

                const key = this.getRelationshipKey(id1, id2);
                const relationship = this.coAppearances[key];

                if (!relationship) {
                    container.innerHTML = `
                        <div class="empty-state">
                            这两个角色没有共同出现的支援卡
                        </div>
                    `;
                    return;
                }

                const cardsHTML = relationship.cards.map(card => {
                    const cardNum = card.imageNum;
                    const padNum = String(cardNum).padStart(3, '0');
                    const imgPath = `images/image_${padNum}.png`;
                    
                    return `
                        <div class="card-item">
                            <img src="${imgPath}" alt="${card.name}" class="card-image">
                            <div class="card-name">${card.name}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = cardsHTML;
            }
        }

        // 等待页面和数据加载完成
        window.addEventListener('load', function() {
            if (typeof characters !== 'undefined' && typeof coAppearances !== 'undefined') {
                new NetworkVisualizer('networkCanvas', characters, coAppearances);
            } else {
                console.error('数据未加载');
            }
        });
    </script>
</body>
</html>
